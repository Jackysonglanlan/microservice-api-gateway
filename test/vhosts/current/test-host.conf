#

upstream test_backends {
  server localhost:7778;
}

server {
  listen *:7777;
  default_type application/json;

  resolver 8.8.8.8; # used when we send http request over cosocket

  location = /demo-lua-json {
    content_by_lua_block {
      ngx.say(JSON.encode({type = "embed", msg = "hahahhhh"}))
    }
  }

  location ~ ^/lua-demo/(.+) {
    content_by_lua_file lua-demo/$1.lua;
  }

  location ~ ^/cache-test/.+ {
    access_by_lua_block{
      local autoCache = require('server.filters.auto-cache.auto-cache')
      autoCache.applyAutoCache(ngx)
    }

    proxy_pass            http://test_backends;

    header_filter_by_lua_block{
      local autoCacheHeadHandler = require('server.filters.auto-cache.auto-cache-response-header-handler')
      autoCacheHeadHandler.detectBackendCacheRequest(ngx)
    }

    body_filter_by_lua_block{
      local autoCacheMaker = require('server.filters.auto-cache.auto-cache-maker')
      autoCacheMaker.triggerAutoCacheIfDetectedFlag(ngx)
    }
  }

  location = /api-sign-check {
    # 拦截请求
    access_by_lua_block{
      local apiSignChecker = require('server.filters.api-sign-checker')
      apiSignChecker.checkAPISign()
    }
    proxy_pass            http://test_backends;
  }

  location ~ ^/api/([^/]+)/?(.*) {
    content_by_lua_block{
      local router = require('server.router')
      router.dispatch('/api', ngx.var[1], ngx.var[2]) -- 等价于 nginx $1 $2
    }
  }


}
